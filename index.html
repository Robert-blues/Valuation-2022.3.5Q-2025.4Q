<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íˆ¬ìê¸ˆìœµíŒ€ í‰ê°€ ìì‚°(2022.3.5Q~2025.4Q)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #map {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 280px;
    }
    #sidebar {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 280px;
      background: #ffffff;
      border-left: 1px solid #ddd;
      box-shadow: -2px 0 4px rgba(0,0,0,0.05);
      padding: 10px 12px;
      overflow-y: auto;
      box-sizing: border-box;
      font-size: 13px;
    }
    #sidebar h2 {
      font-size: 16px;
      margin: 4px 0 8px 0;
    }
    #sidebar h3 {
      font-size: 13px;
      margin: 10px 0 4px 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 2px;
    }
    .section {
      margin-bottom: 10px;
    }
    .filter-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 2px 0;
    }
    .filter-left {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      border: 1px solid #888;
    }
    #type-list, #pool-list {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 4px;
      background: #fafafa;
    }
    #search-input,
    #borrower-input,
    #type-search,
    #pool-search,
    #disco-input {
      width: 100%;
      padding: 4px;
      font-size: 12px;
      margin-bottom: 4px;
      box-sizing: border-box;
    }
    #search-btn, #reset-btn, #borrower-btn, #disco-btn {
      width: 100%;
      padding: 6px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background: #f5f5f5;
      cursor: pointer;
      margin-top: 4px;
    }
    #type-all, #type-none,
    #pool-all, #pool-none {
      padding: 3px 5px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f5f5f5;
      border-radius: 3px;
    }
    #search-btn:hover, #reset-btn:hover, #borrower-btn:hover, #disco-btn:hover,
    #type-all:hover, #type-none:hover,
    #pool-all:hover, #pool-none:hover {
      background: #e9e9e9;
    }
    .mini-btn-row {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
    }
    .asset-info-wrap {
      min-width: 320px;
      max-width: 420px;
      max-height: 320px;
      overflow-y: auto;
      font-size: 11px;
    }
    .asset-info-wrap p {
      margin: 2px 0;
    }
    .asset-info-wrap b {
      display: inline-block;
      min-width: 130px;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div id="sidebar">
  <h2>íˆ¬ìê¸ˆìœµíŒ€ í‰ê°€(2022.3.5Q ~ 2025.4Q)</h2>

  <div class="section">
    <button id="reset-btn">ğŸ”„ í•„í„° ì´ˆê¸°í™” (ì „ì²´ ë³´ê¸°)</button>
  </div>

  <div class="section">
    <h3>ì§€ë²ˆ / ì£¼ì†Œ ê²€ìƒ‰</h3>
    <input id="search-input" type="text" placeholder="ì˜ˆ: ê²½ê¸°ë„ ì•ˆì‚°ì‹œ ìƒë¡êµ¬ ë³¸ì˜¤ë™ 730-2" />
    <button id="search-btn">í˜„ì¬ ì§€ë„ì—ì„œ ê²€ìƒ‰</button>
  </div>

  <div class="section">
    <h3>ì°¨ì£¼ëª… ê²€ìƒ‰</h3>
    <input id="borrower-input" type="text" placeholder="ì°¨ì£¼ëª… ì…ë ¥" />
    <button id="borrower-btn">ì°¨ì£¼ëª…ìœ¼ë¡œ í•„í„°</button>
  </div>

  <!-- âœ¨ ìƒˆë¡œìš´ Disco ê²€ìƒ‰ UI ì¶”ê°€ -->
  <div class="section">
    <h3>Disco ì£¼ì†Œ ê²€ìƒ‰</h3>
    <input id="disco-input" type="text" placeholder="ì§€ë²ˆ ë˜ëŠ” ì£¼ì†Œ ì…ë ¥" />
    <button id="disco-btn">Discoì—ì„œ ê²€ìƒ‰í•˜ê¸°</button>
    <p style="font-size:11px;color:#666;margin-top:4px;">
      ì…ë ¥í•œ ì§€ë²ˆ/ì£¼ì†Œë¥¼ <b>disco.re</b>ì—ì„œ ë°”ë¡œ ê²€ìƒ‰í•˜ë©°,<br>ê²€ìƒ‰ì–´ê°€ ìë™ìœ¼ë¡œ í´ë¦½ë³´ë“œì— ë³µì‚¬ë©ë‹ˆë‹¤.
    </p>
  </div>

  <div class="section">
    <h3>ìì‚°ìœ í˜• í•„í„°</h3>
    <input id="type-search" type="text" placeholder="ìì‚°ìœ í˜• ê²€ìƒ‰" />
    <div class="mini-btn-row">
      <button id="type-all">ì „ì²´</button>
      <button id="type-none">í•´ì œ</button>
    </div>
    <div id="type-list"></div>
  </div>

  <div class="section">
    <h3>Pool í•„í„°</h3>
    <input id="pool-search" type="text" placeholder="Pool ê²€ìƒ‰" />
    <div class="mini-btn-row">
      <button id="pool-all">ì „ì²´</button>
      <button id="pool-none">í•´ì œ</button>
    </div>
    <div id="pool-list"></div>
  </div>
</div>

<script>
/* ========= ìˆ«ì í¬ë§· ê¸°ëŠ¥ ========= */
function formatNumberWithCommas(value) {
  const num = Number(value);
  if (isNaN(num)) return value;
  return num.toLocaleString("ko-KR");
}
function formatIntegerWithCommas(value) {
  let num = Number(value);
  if (isNaN(num)) return value;
  return Math.round(num).toLocaleString("ko-KR");
}

/* ========= Pool ìƒ‰ìƒ ========= */
const POOL_ICON_NAMES = ["red","blue","green","purple","yellow","ltblue","orange","pink"];
const POOL_CSS_COLORS = ["#e74c3c","#3498db","#2ecc71","#9b59b6","#f1c40f","#1abc9c","#e67e22","#fd79a8"];

let poolIndexMap = {};
function getPoolIndex(pool) {
  const key = pool || "ê¸°íƒ€";
  if (poolIndexMap[key] !== undefined) return poolIndexMap[key];
  const idx = Object.keys(poolIndexMap).length % POOL_ICON_NAMES.length;
  poolIndexMap[key] = idx;
  return idx;
}
function getPoolIconUrl(pool) {
  return "http://maps.google.com/mapfiles/ms/icons/" +
         POOL_ICON_NAMES[getPoolIndex(pool)] + "-dot.png";
}
function getPoolCssColor(pool) {
  return POOL_CSS_COLORS[getPoolIndex(pool)];
}

/* ========= InfoWindow HTML ìƒì„± ========= */
function buildInfoHtml(asset) {
  const fields = [
    { key: "Pool", label: "Pool" },
    { key: "ëŒ€í‘œì§€ë²ˆ", label: "ëŒ€í‘œì§€ë²ˆ" },
    { key: "ëŒ€í‘œì§€ë²ˆ_ì •ì œ", label: "ëŒ€í‘œì§€ë²ˆ_ì •ì œ" },
    { key: "ì°¨ì£¼ëª…", label: "ì°¨ì£¼ëª…" },
    { key: "OPB", label: "OPB", formatNumber: true },
    { key: "ë¬¼ê±´ë²ˆí˜¸", label: "ë¬¼ê±´ë²ˆí˜¸" },
    { key: "ì†Œì¬ì§€1", label: "ì†Œì¬ì§€1" },
    { key: "ì†Œì¬ì§€2", label: "ì†Œì¬ì§€2" },
    { key: "ì†Œì¬ì§€3", label: "ì†Œì¬ì§€3" },
    { key: "ì†Œì¬ì§€4", label: "ì†Œì¬ì§€4" },
    { key: "ìì‚°ìœ í˜•", label: "ìì‚°ìœ í˜•" },
    { key: "ê·¼ì €ë‹¹ì„¤ì •ìˆœìœ„", label: "ê·¼ì €ë‹¹ì„¤ì •ìˆœìœ„" },
    { key: "ê·¼ì €ë‹¹ê¶Œì„¤ì •ì•¡", label: "ê·¼ì €ë‹¹ê¶Œì„¤ì •ì•¡", formatNumber: true },
    { key: "ëŒ€ì§€ë©´ì (í‰)", label: "í† ì§€ë©´ì (í‰)" },
    { key: "ê±´ë¬¼ë©´ì (í‰)", label: "ê±´ë¬¼ë©´ì (í‰)" },
    { key: "í† ì§€", label: "í† ì§€", formatNumber: true },
    { key: "ê±´ë¬¼", label: "ê±´ë¬¼", formatNumber: true },
    { key: "ê¸°ê³„ê¸°êµ¬", label: "ê¸°ê³„ê¸°êµ¬", formatNumber: true },
    { key: "ì œì‹œì™¸", label: "ì œì‹œì™¸", formatNumber: true },
    { key: "í•©ê³„", label: "ê°ì •í‰ê°€ì•¡ í•©ê³„", formatNumber: true },
    { key: "1ì•ˆ í‰ë‹¹ê°€ì•¡(í† ì§€+ê±´ë¬¼)", label: "1ì•ˆ í‰ë‹¹ê°€ì•¡(í† ì§€+ê±´ë¬¼)", formatNumber: true },
    { key: "2ì•ˆ í‰ë‹¹ê°€ì•¡(í† ì§€+ê±´ë¬¼)", label: "2ì•ˆ í‰ë‹¹ê°€ì•¡(í† ì§€+ê±´ë¬¼)", formatNumber: true },
    { key: "ê´€í• ë²•ì›", label: "ê´€í• ë²•ì›" },
    { key: "ê²½ë§¤ì‚¬ê±´ë²ˆí˜¸(ì„ í–‰ê¸°ì¤€)", label: "ê²½ë§¤ì‚¬ê±´ë²ˆí˜¸(ì„ í–‰ê¸°ì¤€)" },
    { key: "íšŒì°¨ ë° ê²°ê³¼", label: "íšŒì°¨ ë° ê²°ê³¼" },
    { key: "ë‚™ì°°/ë§¤ë§¤ê¸ˆì•¡", label: "ë‚™ì°°/ë§¤ë§¤ê¸ˆì•¡", formatNumber: true },
    { key: "ë‚™ì°°/ë§¤ë§¤ê¸ˆì•¡ í‰ë‹¹ê°€", label: "ë‚™ì°°/ë§¤ë§¤ê¸ˆì•¡ í‰ë‹¹ê°€", formatInteger: true },
    { key: "ë¹„ê³ ", label: "ë¹„ê³ " },
    { key: "íšŒìƒë²•ì›", label: "íšŒìƒë²•ì›" },
    { key: "íšŒìƒì‚¬ê±´ë²ˆí˜¸", label: "íšŒìƒì‚¬ê±´ë²ˆí˜¸" },
    { key: "íšŒìƒì§„í–‰ìƒí™©", label: "íšŒìƒì§„í–‰ìƒí™©" }
  ];

  let rows = "";
  fields.forEach(field => {
    let v = asset[field.key];
    if (v === null || v === undefined) v = "";

    if (field.formatNumber) v = formatNumberWithCommas(v);
    if (field.formatInteger) v = formatIntegerWithCommas(v);

    rows += `<p><b>${field.label}</b> ${v}</p>`;
  });

  return `<div class="asset-info-wrap">${rows}</div>`;
}

/* ========= ì „ì—­ ìƒíƒœ ========= */
let map, geocoder, searchCircle;
let markers = [];
let typeVisibility = {};
let poolVisibility = {};
let borrowerFilter = "";

/* ========= JSON ë°ì´í„° ë¡œë“œ ========= */
async function loadAssets() {
  const res = await fetch("data/assets.json");
  return await res.json();
}

/* ========= ë§ˆì»¤ ìƒì„± ========= */
function createMarker(asset) {
  if (!asset.lat || !asset.lng) return null;

  const marker = new google.maps.Marker({
    position: { lat: asset.lat, lng: asset.lng },
    map,
    icon: getPoolIconUrl(asset["Pool"]),
    title: asset["ëŒ€í‘œì§€ë²ˆ_ì •ì œ"] || asset["ëŒ€í‘œì§€ë²ˆ"] || ""
  });

  const iw = new google.maps.InfoWindow({ content: buildInfoHtml(asset) });

  marker.addListener("click", () => iw.open(map, marker));

  return marker;
}

/* ========= í•„í„° ì ìš© ========= */
function updateMarkerVisibility() {
  const q = borrowerFilter.toLowerCase();

  markers.forEach(obj => {
    const matchType = typeVisibility[obj.typeKey] !== false;
    const matchPool = poolVisibility[obj.poolKey] !== false;
    let matchBorrower = true;

    if (q) matchBorrower = (obj.borrowerName || "").toLowerCase().includes(q);

    obj.marker.setVisible(matchType && matchPool && matchBorrower);
  });
}

function fitMapToVisibleMarkers() {
  const bounds = new google.maps.LatLngBounds();
  let hasVisible = false;

  markers.forEach(obj => {
    if (obj.marker.getVisible()) {
      bounds.extend(obj.marker.getPosition());
      hasVisible = true;
    }
  });

  if (hasVisible) map.fitBounds(bounds);
}

/* ========= ì§€ë„ ì´ˆê¸°í™” ========= */
async function initMap() {
  const assets = await loadAssets();

  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 7,
    center: { lat: 36.5, lng: 127.8 }
  });

  geocoder = new google.maps.Geocoder();

  const bounds = new google.maps.LatLngBounds();
  const typeCounts = {};
  const poolCounts = {};

  assets.forEach(asset => {
    if (!asset.lat || !asset.lng) return;

    const typeKey = asset["ìì‚°ìœ í˜•"] || "ê¸°íƒ€";
    const poolKey = asset["Pool"] || "ë¯¸ì§€ì •";
    const borrowerName = asset["ì°¨ì£¼ëª…"] || "";

    if (!typeCounts[typeKey]) { typeCounts[typeKey] = 0; typeVisibility[typeKey] = true; }
    if (!poolCounts[poolKey]) { poolCounts[poolKey] = 0; poolVisibility[poolKey] = true; }

    typeCounts[typeKey]++;
    poolCounts[poolKey]++;

    const marker = createMarker(asset);
    if (!marker) return;

    markers.push({
      marker,
      typeKey,
      poolKey,
      borrowerName,
      asset
    });

    bounds.extend(marker.getPosition());
  });

  map.fitBounds(bounds);

  renderTypeFilters(typeCounts);
  renderPoolFilters(poolCounts);

  setupTypeFilterUI();
  setupPoolFilterUI();
  setupSearchBox();
  setupBorrowerBox();
  setupDiscoSearchBox();  // âœ¨ ì—¬ê¸° ì¶”ê°€ë¨!
  setupResetButton();
}

/* ========= Disco ê²€ìƒ‰ ê¸°ëŠ¥ + í´ë¦½ë³´ë“œ ë³µì‚¬ ========= */
function setupDiscoSearchBox() {
  const input = document.getElementById("disco-input");
  const btn = document.getElementById("disco-btn");

  function searchDisco() {
    const q = input.value.trim();
    if (!q) {
      alert("ê²€ìƒ‰í•  ì§€ë²ˆ ë˜ëŠ” ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    // ìë™ í´ë¦½ë³´ë“œ ë³µì‚¬
    navigator.clipboard.writeText(q).then(() => {
      console.log("í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ:", q);
    });

    const url = `https://disco.re/search?keyword=${encodeURIComponent(q)}`;

    // ìƒˆ íƒ­ì—ì„œ Disco ê²€ìƒ‰ ì‹¤í–‰
    window.open(url, "_blank");
  }

  btn.addEventListener("click", searchDisco);
  input.addEventListener("keyup", e => {
    if (e.key === "Enter") searchDisco();
  });
}

/* ========= ìì‚°ìœ í˜• í•„í„° ë Œë”ë§ ========= */
function renderTypeFilters(typeCounts) {
  const list = document.getElementById("type-list");
  list.innerHTML = "";

  Object.entries(typeCounts)
    .sort((a, b) => b[1] - a[1])
    .forEach(([key, count]) => {
      const row = document.createElement("div");
      row.className = "filter-item";

      const left = document.createElement("div");
      left.className = "filter-left";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = true;
      checkbox.setAttribute("data-type", key);

      const dot = document.createElement("span");
      dot.className = "dot";
      dot.style.backgroundColor = "#888";

      const label = document.createElement("span");
      label.textContent = key;

      left.appendChild(checkbox);
      left.appendChild(dot);
      left.appendChild(label);

      const countSpan = document.createElement("span");
      countSpan.textContent = count + "ê±´";

      row.appendChild(left);
      row.appendChild(countSpan);

      list.appendChild(row);

      checkbox.addEventListener("change", function () {
        typeVisibility[key] = this.checked;
        updateMarkerVisibility();
        fitMapToVisibleMarkers();
      });
    });
}

/* ========= Pool í•„í„° ë Œë”ë§ ========= */
function renderPoolFilters(poolCounts) {
  const list = document.getElementById("pool-list");
  list.innerHTML = "";

  Object.entries(poolCounts)
    .sort((a, b) => b[1] - a[1])
    .forEach(([key, count]) => {
      const row = document.createElement("div");
      row.className = "filter-item";

      const left = document.createElement("div");
      left.className = "filter-left";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = true;
      checkbox.setAttribute("data-pool", key);

      const dot = document.createElement("span");
      dot.className = "dot";
      dot.style.backgroundColor = getPoolCssColor(key);

      const label = document.createElement("span");
      label.textContent = key;

      left.appendChild(checkbox);
      left.appendChild(dot);
      left.appendChild(label);

      const countSpan = document.createElement("span");
      countSpan.textContent = count + "ê±´";

      row.appendChild(left);
      row.appendChild(countSpan);

      list.appendChild(row);

      checkbox.addEventListener("change", function () {
        poolVisibility[key] = this.checked;
        updateMarkerVisibility();
        fitMapToVisibleMarkers();
      });
    });
}

/* ========= í•„í„° UI ========= */
function setupTypeFilterUI() {
  const searchInput = document.getElementById("type-search");
  const btnAll = document.getElementById("type-all");
  const btnNone = document.getElementById("type-none");
  const list = document.getElementById("type-list");

  searchInput.addEventListener("keyup", function () {
    const q = this.value.toLowerCase();
    Array.from(list.children).forEach(row => {
      const label = row.querySelector(".filter-left span:last-child").textContent.toLowerCase();
      row.style.display = label.includes(q) ? "" : "none";
    });
  });

  btnAll.addEventListener("click", function () {
    list.querySelectorAll("input[data-type]").forEach(box => {
      box.checked = true;
      typeVisibility[box.getAttribute("data-type")] = true;
    });
    updateMarkerVisibility();
    fitMapToVisibleMarkers();
  });

  btnNone.addEventListener("click", function () {
    list.querySelectorAll("input[data-type]").forEach(box => {
      box.checked = false;
      typeVisibility[box.getAttribute("data-type")] = false;
    });
    updateMarkerVisibility();
    fitMapToVisibleMarkers();
  });
}

function setupPoolFilterUI() {
  const searchInput = document.getElementById("pool-search");
  const btnAll = document.getElementById("pool-all");
  const btnNone = document.getElementById("pool-none");
  const list = document.getElementById("pool-list");

  searchInput.addEventListener("keyup", function () {
    const q = this.value.toLowerCase();
    Array.from(list.children).forEach(row => {
      const label = row.querySelector(".filter-left span:last-child").textContent.toLowerCase();
      row.style.display = label.includes(q) ? "" : "none";
    });
  });

  btnAll.addEventListener("click", function () {
    list.querySelectorAll("input[data-pool]").forEach(box => {
      box.checked = true;
      poolVisibility[box.getAttribute("data-pool")] = true;
    });
    updateMarkerVisibility();
    fitMapToVisibleMarkers();
  });

  btnNone.addEventListener("click", function () {
    list.querySelectorAll("input[data-pool]").forEach(box => {
      box.checked = false;
      poolVisibility[box.getAttribute("data-pool")] = false;
    });
    updateMarkerVisibility();
    fitMapToVisibleMarkers();
  });
}

/* ========= ì£¼ì†Œ / ì§€ë²ˆ ê²€ìƒ‰ ========= */
function setupSearchBox() {
  const input = document.getElementById("search-input");
  const btn = document.getElementById("search-btn");

  function doSearch() {
    const q = input.value.trim();
    if (!q) return;

    geocoder.geocode({ address: q, region: "kr" }, (results, status) => {
      if (status === "OK") {
        const loc = results[0].geometry.location;

        if (searchCircle) searchCircle.setMap(null);

        searchCircle = new google.maps.Circle({
          map,
          center: loc,
          radius: 1000,
          fillColor: "#4285F4",
          fillOpacity: 0.18,
          strokeColor: "#4285F4",
          strokeOpacity: 0.9,
          strokeWeight: 1
        });

        map.fitBounds(searchCircle.getBounds());
      } else {
        alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    });
  }

  btn.addEventListener("click", doSearch);
  input.addEventListener("keyup", e => {
    if (e.key === "Enter") doSearch();
  });
}

/* ========= ì°¨ì£¼ëª… ê²€ìƒ‰ ========= */
function setupBorrowerBox() {
  const input = document.getElementById("borrower-input");
  const btn = document.getElementById("borrower-btn");

  function apply() {
    borrowerFilter = input.value.trim();
    updateMarkerVisibility();
    fitMapToVisibleMarkers();
  }

  btn.addEventListener("click", apply);
  input.addEventListener("keyup", e => {
    if (e.key === "Enter") apply();
  });
}

/* ========= í•„í„° ì´ˆê¸°í™” ========= */
function setupResetButton() {
  const btn = document.getElementById("reset-btn");

  btn.addEventListener("click", () => {
    borrowerFilter = "";

    Object.keys(typeVisibility).forEach(k => typeVisibility[k] = true);
    Object.keys(poolVisibility).forEach(k => poolVisibility[k] = true);

    document.querySelectorAll("input[data-type], input[data-pool]").forEach(box => box.checked = true);

    document.getElementById("type-search").value = "";
    document.getElementById("pool-search").value = "";
    document.getElementById("search-input").value = "";
    document.getElementById("borrower-input").value = "";
    document.getElementById("disco-input").value = "";

    ["type-list","pool-list"].forEach(id => {
      Array.from(document.getElementById(id).children).forEach(row => row.style.display = "");
    });

    if (searchCircle) {
      searchCircle.setMap(null);
      searchCircle = null;
    }

    updateMarkerVisibility();
    fitMapToVisibleMarkers();
  });
}
</script>

<!-- ğŸ”‘ ì—¬ê¸°ì— ë³¸ì¸ì˜ Google Maps API Key ì…ë ¥ -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFiReDrisaJOYbq7gyZ66JJ1cBSar83vQ&callback=initMap" async defer></script>

</body>
</html>
