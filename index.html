<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íˆ¬ìê¸ˆìœµíŒ€ í‰ê°€ ìì‚° Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

    /* =========================
       ğŸ” Login Overlay
    ========================= */
    #login-overlay{
      position: fixed;
      inset: 0;
      background:
        linear-gradient(rgba(0,0,0,0.45), rgba(0,0,0,0.45)),
        url("data/login_bg.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    .login-box{
      width: 380px;
      border-radius: 12px;
      padding: 26px 28px;
      text-align: center;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.55);
    }
    .login-box h2{ margin: 0 0 16px 0; font-size: 18px; letter-spacing: -0.2px; }
    .login-box input{
      width: 100%;
      box-sizing: border-box;
      height: 42px;
      padding: 10px 12px;
      margin-bottom: 10px;
      font-size: 14px;
      line-height: 20px;
      border: 1px solid #cfcfcf;
      border-radius: 8px;
      outline: none;
      background: rgba(255,255,255,0.92);
    }
    .login-box input:focus{
      border-color: #7aa7ff;
      box-shadow: 0 0 0 3px rgba(122,167,255,0.25);
    }
    .login-box button{
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #d0d0d0;
      background: #efefef;
      cursor: pointer;
    }
    .login-box button:hover{ background:#e6e6e6; }
    .login-note{ margin: 10px 0 0 0; font-size: 12px; color: #444; opacity: 0.95; }

    /* =========================
       ğŸ—ºï¸ Layout
    ========================= */
    #map { position:absolute; top:0; left:0; right:300px; bottom:0; }
    #sidebar {
      position:absolute; top:0; right:0; bottom:0; width:300px;
      background:#fff; border-left:1px solid #ddd; box-shadow:-2px 0 4px rgba(0,0,0,0.05);
      padding:10px 12px; box-sizing:border-box; overflow-y:auto; font-size:13px;
    }
    #sidebar h2 { font-size:16px; margin:4px 0 10px 0; }
    #sidebar h3 { font-size:13px; margin:10px 0 6px 0; border-bottom:1px solid #eee; padding-bottom:4px; }
    .section { margin-bottom:10px; }
    .mini-help { font-size:11px; color:#666; margin:6px 0 0 0; line-height:1.35; }

    input[type="text"]{
      width:100%; box-sizing:border-box; padding:6px; font-size:12px;
      border:1px solid #ccc; border-radius:4px; margin-bottom:6px;
    }
    button{
      width:100%; padding:7px 8px; font-size:12px; cursor:pointer;
      border-radius:4px; border:1px solid #ccc; background:#f5f5f5;
    }
    button:hover{ background:#e9e9e9; }

    .mini-btn-row{ display:flex; gap:6px; margin-bottom:6px; }
    .mini-btn-row button{ width:auto; flex:1; padding:5px; font-size:11px; }

    .list{
      border:1px solid #eee; background:#fafafa; border-radius:4px;
      padding:6px; max-height:180px; overflow-y:auto;
    }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin:4px 0; }
    .left{ display:flex; align-items:center; gap:6px; min-width:0; }
    .left span.label{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:165px; }
    .count{ color:#555; font-size:11px; flex:0 0 auto; }
    .dot{ width:10px; height:10px; border-radius:50%; border:1px solid rgba(0,0,0,0.35); flex:0 0 auto; }

    .toast{
      position:fixed; right:320px; bottom:18px;
      background:rgba(0,0,0,0.78); color:#fff;
      padding:10px 12px; border-radius:8px; font-size:12px;
      opacity:0; transform:translateY(6px);
      transition:opacity 0.18s ease, transform 0.18s ease;
      pointer-events:none; z-index:9999;
    }
    .toast.show{ opacity:1; transform:translateY(0); }

    .iw-wrap{ min-width:320px; max-width:460px; max-height:360px; overflow-y:auto; font-size:12px; line-height:1.35; }
    .iw-row{ margin:2px 0; }
    .iw-row b{ display:inline-block; min-width:160px; }
  </style>
</head>

<body>
  <!-- ğŸ” ë¡œê·¸ì¸ -->
  <div id="login-overlay">
    <div class="login-box">
      <h2>KFNI IB Portfolio Valuation Track</h2>
      <input id="login-id" type="text" placeholder="ID" autocomplete="username" />
      <input id="login-pw" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="login-btn" type="button">ë¡œê·¸ì¸</button>
      <p class="login-note">Designed by SIS</p>
    </div>
  </div>

  <!-- ì•± -->
  <div id="app" style="display:none;">
    <div id="map"></div>

    <div id="sidebar">
      <h2>íˆ¬ìê¸ˆìœµíŒ€ í‰ê°€ ìì‚° Map</h2>

      <div class="section">
        <button id="reset-btn">ğŸ”„ í•„í„° ì´ˆê¸°í™” (ì „ì²´ ë³´ê¸°)</button>
      </div>

      <div class="section">
        <h3>ì§€ë²ˆ / ì£¼ì†Œ ê²€ìƒ‰</h3>
        <input id="search-input" type="text" placeholder="ì˜ˆ: ê²½ê¸°ë„ ì•ˆì‚°ì‹œ ìƒë¡êµ¬ ë³¸ì˜¤ë™ 730-2" />
        <button id="search-btn">í˜„ì¬ ì§€ë„ì—ì„œ ê²€ìƒ‰</button>
        <p class="mini-help">ì…ë ¥í•œ ì£¼ì†Œ/ì§€ë²ˆì„ ì§€ë„ì—ì„œ ì°¾ì•„ ë°˜ê²½(1km)ì„ í‘œì‹œí•˜ê³  í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
      </div>

      <div class="section">
        <h3>ì°¨ì£¼ëª… ê²€ìƒ‰</h3>
        <input id="borrower-input" type="text" placeholder="ì°¨ì£¼ëª… ì…ë ¥ (ë¶€ë¶„ê²€ìƒ‰)" />
        <button id="borrower-btn">ì°¨ì£¼ëª… ìœ„ì¹˜ë¡œ ì´ë™</button>
        <p class="mini-help">
          âœ… í•´ë‹¹ ì°¨ì£¼ ë§ˆì»¤ë§Œ <b>ê¸°ë³¸ í•€ ëª¨ì–‘</b>ìœ¼ë¡œ ëˆˆì— ë„ê²Œ í‘œì‹œí•©ë‹ˆë‹¤.<br/>
          âœ… ê° ë§ˆì»¤ ì£¼ë³€ì— <b>2km ë°˜ê²½</b> ì›ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        </p>
      </div>

      <div class="section">
        <h3>Disco ì£¼ì†Œ ê²€ìƒ‰</h3>
        <input id="disco-input" type="text" placeholder="ì§€ë²ˆ ë˜ëŠ” ì£¼ì†Œ ì…ë ¥" />
        <button id="disco-btn">Discoì—ì„œ ê²€ìƒ‰í•˜ê¸° (ë³µì‚¬ + ìƒˆíƒ­)</button>
        <p class="mini-help">ë²„íŠ¼ í´ë¦­ ì‹œ ì…ë ¥ê°’ì´ ìë™ìœ¼ë¡œ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ê³ , disco.re ê²€ìƒ‰ì´ ìƒˆ íƒ­ì—ì„œ ì—´ë¦½ë‹ˆë‹¤.</p>
      </div>

      <div class="section">
        <h3>ìì‚°ìœ í˜• í•„í„°</h3>
        <input id="type-search" type="text" placeholder="ìì‚°ìœ í˜• ê²€ìƒ‰" />
        <div class="mini-btn-row">
          <button id="type-all">ì „ì²´</button>
          <button id="type-none">í•´ì œ</button>
        </div>
        <div id="type-list" class="list"></div>
      </div>

      <div class="section">
        <h3>Pool í•„í„°</h3>
        <input id="pool-search" type="text" placeholder="Pool ê²€ìƒ‰" />
        <div class="mini-btn-row">
          <button id="pool-all">ì „ì²´</button>
          <button id="pool-none">í•´ì œ</button>
        </div>
        <div id="pool-list" class="list"></div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <script>
    /* =========================
       ğŸ” Login
    ========================= */
    function doLogin() {
      var id = (document.getElementById("login-id").value || "").trim();
      var pw = (document.getElementById("login-pw").value || "").trim();
      if (id === "kfniib" && pw === "kiwoomfni") {
        document.getElementById("login-overlay").style.display = "none";
        document.getElementById("app").style.display = "block";
      } else {
        alert("ID ë˜ëŠ” Passwordê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    }
    document.addEventListener("DOMContentLoaded", function(){
      var btn = document.getElementById("login-btn");
      if (btn) btn.addEventListener("click", doLogin);
      document.addEventListener("keydown", function(e){
        var overlay = document.getElementById("login-overlay");
        if (!overlay || overlay.style.display === "none") return;
        if (e.key === "Enter") doLogin();
      });
    });

    // -------------------------
    // ìœ í‹¸
    // -------------------------
    function toNumber(v){
      if (v === null || v === undefined) return NaN;
      if (typeof v === "number") return v;
      var s = String(v).replace(/,/g, "").trim();
      if (s === "") return NaN;
      return Number(s);
    }
    function fmtComma(v){
      var n = toNumber(v);
      if (isNaN(n)) return (v === null || v === undefined) ? "" : String(v);
      return Math.round(n).toLocaleString("ko-KR");
    }
    function fmtIntegerComma(v){
      var n = toNumber(v);
      if (isNaN(n)) return (v === null || v === undefined) ? "" : String(v);
      return Math.trunc(n).toLocaleString("ko-KR");
    }
    function safeText(v){
      if (v === null || v === undefined) return "";
      return String(v);
    }
    function pickAny(asset, keys){
      for (var i = 0; i < keys.length; i++){
        var k = keys[i];
        if (Object.prototype.hasOwnProperty.call(asset, k)){
          var v = asset[k];
          if (v !== null && v !== undefined && String(v).trim() !== "") return v;
        }
      }
      return "";
    }
    function formatAreaPyeong(v){
      if (v === null || v === undefined) return "";
      var s = String(v).replace(/,/g, "").trim();
      if (s === "") return "";
      var n = Number(s);
      if (isNaN(n)) return String(v);
      return n.toLocaleString("ko-KR", { maximumFractionDigits: 4 });
    }

    function resolveLandAreaPyeong(asset){
      var v = pickAny(asset, [
        "ëŒ€ì§€ë©´ì (í‰)","ëŒ€ì§€ë©´ì (í‰ )","ëŒ€ì§€ë©´ì ","ëŒ€ì§€ë©´ì ¹(í‰)","ëŒ€ì§€ë©´ì ¹",
        "í† ì§€ë©´ì (í‰)","í† ì§€ë©´ì ¹(í‰)","í† ì§€ë©´ì ","í† ì§€ë©´ì ¹"
      ]);
      if (v !== "") return v;
      var keys = Object.keys(asset || {});
      for (var i = 0; i < keys.length; i++){
        var k = keys[i];
        var kk = k.replace(/\s+/g, "");
        var hasLandWord = (kk.indexOf("ëŒ€ì§€") !== -1) || (kk.indexOf("í† ì§€") !== -1);
        var hasArea = (kk.indexOf("ë©´ì ") !== -1);
        var hasPyeong = (kk.indexOf("í‰") !== -1) || (kk.indexOf("(í‰") !== -1);
        if (hasLandWord && hasArea && hasPyeong){
          var val = asset[k];
          if (val !== null && val !== undefined && String(val).trim() !== "") return val;
        }
      }
      return "";
    }
    function resolveBldgAreaPyeong(asset){
      var v = pickAny(asset, ["ê±´ë¬¼ë©´ì (í‰)","ê±´ë¬¼ë©´ì ¹(í‰)","ê±´ë¬¼ë©´ì ","ê±´ë¬¼ë©´ì ¹"]);
      if (v !== "") return v;
      var keys = Object.keys(asset || {});
      for (var i = 0; i < keys.length; i++){
        var k = keys[i];
        var kk = k.replace(/\s+/g, "");
        if (kk.indexOf("ê±´ë¬¼") !== -1 && kk.indexOf("ë©´ì ") !== -1 && (kk.indexOf("í‰") !== -1 || kk.indexOf("(í‰") !== -1)){
          var val = asset[k];
          if (val !== null && val !== undefined && String(val).trim() !== "") return val;
        }
      }
      return "";
    }

    function showToast(msg){
      var el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(function(){ el.classList.remove("show"); }, 1500);
    }

    // -------------------------
    // Pool ì•„ì´ì½˜
    // -------------------------
    var POOL_ICON_NAMES = ["red","blue","green","purple","yellow","ltblue","orange","pink"];
    var POOL_CSS_COLORS = ["#e74c3c","#3498db","#2ecc71","#9b59b6","#f1c40f","#1abc9c","#e67e22","#fd79a8"];
    var poolIndexMap = {};
    function getPoolIndex(pool){
      var key = pool || "ë¯¸ì§€ì •";
      if (poolIndexMap[key] !== undefined) return poolIndexMap[key];
      var idx = Object.keys(poolIndexMap).length % POOL_ICON_NAMES.length;
      poolIndexMap[key] = idx;
      return idx;
    }
    function getPoolIconUrl(pool){
      var idx = getPoolIndex(pool);
      return "https://maps.google.com/mapfiles/ms/icons/" + POOL_ICON_NAMES[idx] + "-dot.png";
    }
    function getPoolCssColor(pool){
      var idx = getPoolIndex(pool);
      return POOL_CSS_COLORS[idx];
    }

    // âœ… ì°¨ì£¼ í•˜ì´ë¼ì´íŠ¸ëŠ” â€œê¸°ë³¸ í•€(ê¸°ë³¸ marker)â€ë¡œ: iconì„ nullë¡œ ì£¼ë©´ ê¸°ë³¸ í•€ìœ¼ë¡œ ë³µê·€
    function setMarkerToDefaultPin(marker){
      marker.setIcon(null);
      marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
    }
    function restoreMarkerIcon(marker, baseIconUrl){
      marker.setIcon(baseIconUrl);
      marker.setZIndex(undefined);
    }

    // -------------------------
    // ì „ì—­ ìƒíƒœ
    // -------------------------
    var map, geocoder;
    var searchCircle = null;      // ì£¼ì†Œ ê²€ìƒ‰ ì›(1km)
    var borrowerCircles = [];     // ì°¨ì£¼ ê²€ìƒ‰ ì›(2km, ì—¬ëŸ¬ ê°œ)
    var markers = [];             // { marker, typeKey, poolKey, borrowerName, asset, baseIconUrl, infoWindow }
    var typeVisibility = {};
    var poolVisibility = {};
    var lastOpenInfoWindow = null;

    // -------------------------
    // InfoWindow ìˆœì„œ
    // -------------------------
    var INFO_FIELDS = [
      { key: "Pool", label: "Pool" },
      { key: "ëŒ€í‘œì§€ë²ˆ", label: "ëŒ€í‘œì§€ë²ˆ" },
      { key: "ëŒ€í‘œì§€ë²ˆ_ì •ì œ", label: "ëŒ€í‘œì§€ë²ˆ_ì •ì œ" },
      { key: "ì°¨ì£¼ëª…", label: "ì°¨ì£¼ëª…" },
      { key: "OPB", label: "OPB", fmt: "comma" },
      { key: "ë¬¼ê±´ë²ˆí˜¸", label: "ë¬¼ê±´ë²ˆí˜¸" },
      { key: "ì†Œì¬ì§€1", label: "ì†Œì¬ì§€1" },
      { key: "ì†Œì¬ì§€2", label: "ì†Œì¬ì§€2" },
      { key: "ì†Œì¬ì§€3", label: "ì†Œì¬ì§€3" },
      { key: "ì†Œì¬ì§€4", label: "ì†Œì¬ì§€4" },
      { key: "ìì‚°ìœ í˜•", label: "ìì‚°ìœ í˜•" },
      { key: "ê·¼ì €ë‹¹ì„¤ì •ìˆœìœ„", label: "ê·¼ì €ë‹¹ì„¤ì •ìˆœìœ„" },
      { key: "ê·¼ì €ë‹¹ê¶Œì„¤ì •ì•¡", label: "ê·¼ì €ë‹¹ê¶Œì„¤ì •ì•¡", fmt: "comma" },
      { key: "__land_area", label: "ëŒ€ì§€ë©´ì (í‰)", fmt: "pyeong", pick: function(a){ return resolveLandAreaPyeong(a); } },
      { key: "__bldg_area", label: "ê±´ë¬¼ë©´ì (í‰)", fmt: "pyeong", pick: function(a){ return resolveBldgAreaPyeong(a); } },
      { key: "__land_appraisal", label: "ê°ì •í‰ê°€ì•¡_í† ì§€", fmt: "comma",
        pick: function(a){ return pickAny(a, ["ê°ì •í‰ê°€ì•¡_í† ì§€","ê°ì •í‰ê°€ì•¡-í† ì§€","ê°ì •í‰ê°€ì•¡-ëŒ€ì§€","í† ì§€","ê°ì •í‰ê°€ì•¡-ëŒ€ì§€(í† ì§€)"]); } },
      { key: "__bldg_appraisal", label: "ê°ì •í‰ê°€ì•¡_ê±´ë¬¼", fmt: "comma",
        pick: function(a){ return pickAny(a, ["ê°ì •í‰ê°€ì•¡_ê±´ë¬¼","ê°ì •í‰ê°€ì•¡-ê±´ë¬¼","ê±´ë¬¼"]); } },
      { key: "__mach_appraisal", label: "ê°ì •í‰ê°€ì•¡_ê¸°ê³„ê¸°êµ¬", fmt: "comma",
        pick: function(a){ return pickAny(a, ["ê°ì •í‰ê°€ì•¡_ê¸°ê³„ê¸°êµ¬","ê°ì •í‰ê°€ì•¡-ê¸°ê³„ê¸°êµ¬","ê¸°ê³„ê¸°êµ¬"]); } },
      { key: "__extra_appraisal", label: "ê°ì •í‰ê°€ì•¡_ì œì‹œì™¸", fmt: "comma",
        pick: function(a){ return pickAny(a, ["ê°ì •í‰ê°€ì•¡_ì œì‹œì™¸","ê°ì •í‰ê°€ì•¡-ì œì‹œì™¸","ì œì‹œì™¸"]); } },
      { key: "í•©ê³„", label: "ê°ì •í‰ê°€ì•¡ í•©ê³„", fmt: "comma" },
      { key: "1ì•ˆ í‰ë‹¹ê°€ì•¡(í† ì§€+ê±´ë¬¼)", label: "1ì•ˆ í‰ë‹¹ê°€ì•¡(í† ì§€+ê±´ë¬¼)", fmt: "comma" },
      { key: "2ì•ˆ í‰ë‹¹ê°€ì•¡(í† ì§€+ê±´ë¬¼)", label: "2ì•ˆ í‰ë‹¹ê°€ì•¡(í† ì§€+ê±´ë¬¼)", fmt: "comma" },
      { key: "ê´€í• ë²•ì›", label: "ê´€í• ë²•ì›" },
      { key: "ê²½ë§¤ì‚¬ê±´ë²ˆí˜¸(ì„ í–‰ê¸°ì¤€)", label: "ê²½ë§¤ì‚¬ê±´ë²ˆí˜¸(ì„ í–‰ê¸°ì¤€)" },
      { key: "íšŒì°¨ ë° ê²°ê³¼", label: "íšŒì°¨ ë° ê²°ê³¼" },
      { key: "ë‚™ì°°/ë§¤ë§¤ê¸ˆì•¡", label: "ë‚™ì°°/ë§¤ë§¤ê¸ˆì•¡", fmt: "comma" },
      { key: "ë‚™ì°°/ë§¤ë§¤ê¸ˆì•¡ í‰ë‹¹ê°€", label: "ë‚™ì°°/ë§¤ë§¤ê¸ˆì•¡ í‰ë‹¹ê°€", fmt: "intcomma" },
      { key: "ë¹„ê³ ", label: "ë¹„ê³ " },
      { key: "íšŒìƒë²•ì›", label: "íšŒìƒë²•ì›" },
      { key: "íšŒìƒì‚¬ê±´ë²ˆí˜¸", label: "íšŒìƒì‚¬ê±´ë²ˆí˜¸" },
      { key: "íšŒìƒì§„í–‰ìƒí™©", label: "íšŒìƒì§„í–‰ìƒí™©" }
    ];

    function buildInfoHtml(asset){
      var rows = "";
      for (var i = 0; i < INFO_FIELDS.length; i++){
        var f = INFO_FIELDS[i];
        var v = (typeof f.pick === "function") ? f.pick(asset) : asset[f.key];
        if (f.fmt === "comma") v = fmtComma(v);
        else if (f.fmt === "intcomma") v = fmtIntegerComma(v);
        else if (f.fmt === "pyeong") v = formatAreaPyeong(v);
        else v = safeText(v);
        rows += '<div class="iw-row"><b>' + f.label + ':</b> ' + safeText(v) + '</div>';
      }
      return '<div class="iw-wrap">' + rows + '</div>';
    }

    async function loadAssets(){
      var res = await fetch("data/assets.json", { cache: "no-store" });
      if (!res.ok) throw new Error("assets.json ë¡œë“œ ì‹¤íŒ¨: " + res.status);
      return await res.json();
    }

    // âœ… í•„í„° ì ìš©(ì°¨ì£¼ ì œì™¸)
    function updateMarkerVisibility(){
      for (var i = 0; i < markers.length; i++){
        var obj = markers[i];
        var matchType = (typeVisibility[obj.typeKey] !== false);
        var matchPool = (poolVisibility[obj.poolKey] !== false);
        obj.marker.setVisible(matchType && matchPool);
      }
    }

    function fitMapToVisibleMarkers(){
      var bounds = new google.maps.LatLngBounds();
      var any = false;
      for (var i = 0; i < markers.length; i++){
        var m = markers[i].marker;
        if (m.getVisible()){
          bounds.extend(m.getPosition());
          any = true;
        }
      }
      if (any) map.fitBounds(bounds);
    }

    function clearBorrowerCirclesAndHighlight(){
      // ì› ì œê±°
      for (var i = 0; i < borrowerCircles.length; i++){
        borrowerCircles[i].setMap(null);
      }
      borrowerCircles = [];

      // ì•„ì´ì½˜ ë³µêµ¬(ê¸°ë³¸ Pool-dotìœ¼ë¡œ)
      for (var j = 0; j < markers.length; j++){
        restoreMarkerIcon(markers[j].marker, markers[j].baseIconUrl);
      }
    }

    // âœ… ì°¨ì£¼ëª… ê²€ìƒ‰: í•´ë‹¹ ì°¨ì£¼ â€œë§ˆì»¤ëŠ” í™•ì‹¤íˆ ë³´ì´ê²Œ(ê¸°ë³¸ í•€)â€ + ê° ë§ˆì»¤ 2km ì› + boundsëŠ” ì› í¬í•¨
    function applyBorrowerSearch(){
      var input = document.getElementById("borrower-input");
      var q = (input.value || "").trim().toLowerCase();

      // ê¸°ì¡´ í•˜ì´ë¼ì´íŠ¸/ì› ì œê±°
      clearBorrowerCirclesAndHighlight();

      if (!q) return;

      // í˜„ì¬ 'ë³´ì´ëŠ” ìƒíƒœ(ìì‚°ìœ í˜•/Pool í•„í„° ë°˜ì˜)'ì—ì„œë§Œ ë§¤ì¹­
      var matched = [];
      for (var i = 0; i < markers.length; i++){
        var obj = markers[i];
        if (!obj.marker.getVisible()) continue;
        var b = (obj.borrowerName || "").toLowerCase();
        if (b.indexOf(q) !== -1){
          matched.push(obj);
        }
      }

      if (matched.length === 0){
        alert("í•´ë‹¹ ì°¨ì£¼ëª…ìœ¼ë¡œ ì¡°íšŒë˜ëŠ” ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤. (í˜„ì¬ í•„í„° ì¡°ê±´ ê¸°ì¤€)");
        return;
      }

      // âœ… ë§¤ì¹­ ë§ˆì»¤: ê¸°ë³¸ í•€ìœ¼ë¡œ ë°”ê¾¸ê³ , 2km ì› ìƒì„±
      for (var k = 0; k < matched.length; k++){
        var mo = matched[k];

        // (1) ë§ˆì»¤ë¥¼ ê¸°ë³¸ í•€ìœ¼ë¡œ ë³€ê²½í•´ì„œ í™• ë„ìš°ê¸°
        setMarkerToDefaultPin(mo.marker);

        // (2) ê° ë§ˆì»¤ 2km ì›
        var circle = new google.maps.Circle({
          map: map,
          center: mo.marker.getPosition(),
          radius: 2000,
          fillColor: "#34A853",
          fillOpacity: 0.10,
          strokeColor: "#34A853",
          strokeOpacity: 0.9,
          strokeWeight: 1
        });
        borrowerCircles.push(circle);
      }

      // âœ… í™”ë©´ì€ â€œì›ë“¤ì˜ boundsâ€ë¥¼ unioní•´ì„œ ë‹¤ ë³´ì´ê²Œ
      var bounds = new google.maps.LatLngBounds();
      for (var c = 0; c < borrowerCircles.length; c++){
        bounds.union(borrowerCircles[c].getBounds());
      }
      map.fitBounds(bounds);

      // âœ… InfoWindow â€œì§€ì›Œì§€ì§€ ì•Šê²Œâ€:
      // - ê¸°ì¡´ì— ì—´ë ¤ìˆë˜ InfoWindowê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë‘  (ê°•ì œ close ì•ˆ í•¨)
      // - ì¶”ê°€ë¡œ, ì°¨ì£¼ ê²€ìƒ‰ ê²°ê³¼ì˜ ì²« ë²ˆì§¸ ë§ˆì»¤ InfoWindowë¥¼ ìë™ ì˜¤í”ˆ(ì›í•˜ë©´ ìœ ì§€ ê°€ëŠ¥)
      if (matched[0] && matched[0].infoWindow){
        matched[0].infoWindow.open(map, matched[0].marker);
        lastOpenInfoWindow = matched[0].infoWindow;
      }
    }

    function renderFilterList(containerId, counts, visibilityMap, colorFn, dataAttrName){
      var el = document.getElementById(containerId);
      el.innerHTML = "";
      var entries = Object.entries(counts).sort(function(a,b){ return b[1]-a[1]; });

      for (var i = 0; i < entries.length; i++){
        var key = entries[i][0];
        var count = entries[i][1];

        var row = document.createElement("div");
        row.className = "item";

        var left = document.createElement("div");
        left.className = "left";

        var box = document.createElement("input");
        box.type = "checkbox";
        box.checked = true;
        box.setAttribute(dataAttrName, key);

        var dot = document.createElement("span");
        dot.className = "dot";
        dot.style.backgroundColor = colorFn ? colorFn(key) : "#888";

        var label = document.createElement("span");
        label.className = "label";
        label.textContent = key;

        left.appendChild(box);
        left.appendChild(dot);
        left.appendChild(label);

        var right = document.createElement("span");
        right.className = "count";
        right.textContent = count + "ê±´";

        row.appendChild(left);
        row.appendChild(right);
        el.appendChild(row);

        box.addEventListener("change", function(){
          var k = this.getAttribute(dataAttrName);
          visibilityMap[k] = this.checked;
          updateMarkerVisibility();
          fitMapToVisibleMarkers();

          // í•„í„° ë³€ê²½ ì‹œ ì°¨ì£¼ í•˜ì´ë¼ì´íŠ¸/ì› ì´ˆê¸°í™”(í˜¼ì„  ë°©ì§€)
          clearBorrowerCirclesAndHighlight();
        });
      }
    }

    function setupListSearch(inputId, listId){
      var input = document.getElementById(inputId);
      var list = document.getElementById(listId);
      if (!input || !list) return;

      input.addEventListener("keyup", function(){
        var q = (this.value || "").toLowerCase();
        var rows = list.children;
        for (var i = 0; i < rows.length; i++){
          var row = rows[i];
          var label = row.querySelector(".label");
          var text = label ? label.textContent.toLowerCase() : "";
          row.style.display = (text.indexOf(q) !== -1) ? "" : "none";
        }
      });
    }

    function setAllChecksByDataAttr(listId, dataAttrName, visibilityMap, checked){
      var list = document.getElementById(listId);
      var boxes = list.querySelectorAll("input[" + dataAttrName + "]");
      for (var i = 0; i < boxes.length; i++){
        var box = boxes[i];
        var key = box.getAttribute(dataAttrName);
        box.checked = checked;
        visibilityMap[key] = checked;
      }
      updateMarkerVisibility();
      fitMapToVisibleMarkers();
      clearBorrowerCirclesAndHighlight();
    }

    // ---------- ì£¼ì†Œ ê²€ìƒ‰ ----------
    function setupSearchBox(){
      var input = document.getElementById("search-input");
      var btn = document.getElementById("search-btn");
      if (!input || !btn) return;

      function doSearch(){
        var q = (input.value || "").trim();
        if (!q) return;

        geocoder.geocode({ address: q, region: "kr" }, function(results, status){
          if (status === "OK" && results && results.length){
            var loc = results[0].geometry.location;

            if (searchCircle) searchCircle.setMap(null);
            searchCircle = new google.maps.Circle({
              map: map,
              center: loc,
              radius: 1000,
              fillColor: "#4285F4",
              fillOpacity: 0.15,
              strokeColor: "#4285F4",
              strokeOpacity: 0.85,
              strokeWeight: 1
            });

            map.fitBounds(searchCircle.getBounds());
          } else {
            alert("í•´ë‹¹ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + status);
          }
        });
      }

      btn.addEventListener("click", doSearch);
      input.addEventListener("keyup", function(e){ if (e.key === "Enter") doSearch(); });
    }

    function setupBorrowerBox(){
      var input = document.getElementById("borrower-input");
      var btn = document.getElementById("borrower-btn");
      if (!input || !btn) return;

      btn.addEventListener("click", applyBorrowerSearch);
      input.addEventListener("keyup", function(e){ if (e.key === "Enter") applyBorrowerSearch(); });
    }

    function setupDiscoSearchBox(){
      var input = document.getElementById("disco-input");
      var btn = document.getElementById("disco-btn");
      if (!input || !btn) return;

      async function goDisco(){
        var q = (input.value || "").trim();
        if (!q){ alert("ê²€ìƒ‰í•  ì§€ë²ˆ ë˜ëŠ” ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

        try {
          await navigator.clipboard.writeText(q);
          showToast("í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ âœ…");
        } catch (e) {
          alert("í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ê¶Œí•œ/HTTPS í™•ì¸)\n\nê·¸ë˜ë„ Disco ê²€ìƒ‰ì€ ìƒˆ íƒ­ì—ì„œ ì—´ë¦½ë‹ˆë‹¤.");
        }
        window.open("https://disco.re/search?keyword=" + encodeURIComponent(q), "_blank");
      }

      btn.addEventListener("click", goDisco);
      input.addEventListener("keyup", function(e){ if (e.key === "Enter") goDisco(); });
    }

    function setupResetButton(){
      var btn = document.getElementById("reset-btn");
      if (!btn) return;

      btn.addEventListener("click", function(){
        Object.keys(typeVisibility).forEach(function(k){ typeVisibility[k] = true; });
        Object.keys(poolVisibility).forEach(function(k){ poolVisibility[k] = true; });
        document.querySelectorAll("input[data-type], input[data-pool]").forEach(function(b){ b.checked = true; });

        ["type-search","pool-search","search-input","borrower-input","disco-input"].forEach(function(id){
          var el = document.getElementById(id);
          if (el) el.value = "";
        });

        ["type-list","pool-list"].forEach(function(id){
          var list = document.getElementById(id);
          if (!list) return;
          for (var i = 0; i < list.children.length; i++) list.children[i].style.display = "";
        });

        if (searchCircle){ searchCircle.setMap(null); searchCircle = null; }
        clearBorrowerCirclesAndHighlight();

        updateMarkerVisibility();
        fitMapToVisibleMarkers();
      });
    }

    async function initMap(){
      var assets = await loadAssets();

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: { lat: 36.5, lng: 127.8 },
        clickableIcons: false
      });

      geocoder = new google.maps.Geocoder();

      var bounds = new google.maps.LatLngBounds();
      var typeCounts = {};
      var poolCounts = {};

      for (var i = 0; i < assets.length; i++){
        var asset = assets[i];

        var lat = Number(asset.lat);
        var lng = Number(asset.lng);
        if (!isFinite(lat) || !isFinite(lng)){
          lat = Number(asset.geo_lat);
          lng = Number(asset.geo_lng);
        }
        if (!isFinite(lat) || !isFinite(lng)) continue;

        var typeKey = asset["ìì‚°ìœ í˜•"] || "ê¸°íƒ€";
        var poolKey = asset["Pool"] || "ë¯¸ì§€ì •";
        var borrowerName = asset["ì°¨ì£¼ëª…"] || "";

        if (!typeCounts[typeKey]){ typeCounts[typeKey] = 0; typeVisibility[typeKey] = true; }
        if (!poolCounts[poolKey]){ poolCounts[poolKey] = 0; poolVisibility[poolKey] = true; }
        typeCounts[typeKey] += 1;
        poolCounts[poolKey] += 1;

        var infoHtml = buildInfoHtml(asset);
        var baseIconUrl = getPoolIconUrl(poolKey);

        var marker = new google.maps.Marker({
          position: { lat: lat, lng: lng },
          map: map,
          icon: baseIconUrl,
          title: asset["ëŒ€í‘œì§€ë²ˆ_ì •ì œ"] || asset["ëŒ€í‘œì§€ë²ˆ"] || ""
        });

        var iw = new google.maps.InfoWindow({ content: infoHtml });

        marker.addListener("click", function(){
          iw.open(map, marker);
          lastOpenInfoWindow = iw;
        });

        markers.push({
          marker: marker,
          typeKey: typeKey,
          poolKey: poolKey,
          borrowerName: borrowerName,
          asset: asset,
          baseIconUrl: baseIconUrl,
          infoWindow: iw
        });

        bounds.extend(marker.getPosition());
      }

      if (!bounds.isEmpty()) map.fitBounds(bounds);

      renderFilterList("type-list", typeCounts, typeVisibility, function(){ return "#888"; }, "data-type");
      renderFilterList("pool-list", poolCounts, poolVisibility, getPoolCssColor, "data-pool");

      setupListSearch("type-search", "type-list");
      setupListSearch("pool-search", "pool-list");

      document.getElementById("type-all").addEventListener("click", function(){
        setAllChecksByDataAttr("type-list", "data-type", typeVisibility, true);
      });
      document.getElementById("type-none").addEventListener("click", function(){
        setAllChecksByDataAttr("type-list", "data-type", typeVisibility, false);
      });
      document.getElementById("pool-all").addEventListener("click", function(){
        setAllChecksByDataAttr("pool-list", "data-pool", poolVisibility, true);
      });
      document.getElementById("pool-none").addEventListener("click", function(){
        setAllChecksByDataAttr("pool-list", "data-pool", poolVisibility, false);
      });

      setupSearchBox();
      setupBorrowerBox();
      setupDiscoSearchBox();
      setupResetButton();
    }
  </script>

  <!-- ğŸ”‘ YOUR_JS_API_KEY ë¥¼ ì‹¤ì œ Google Maps JavaScript API í‚¤ë¡œ êµì²´ -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCys3BT1to00AEaF0ZEFXDFDBgod9uRinw&callback=initMap"
    async defer
  ></script>
</body>
</html>
